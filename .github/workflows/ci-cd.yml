name: CI/CD - Tests & D√©ploiement

on:
  push:
    branches: [main, dev, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/ci-cd.yml'
  pull_request:
    branches: [main, dev]
  workflow_dispatch:  # D√©clenchement manuel

env:
  PYTHON_VERSION: '3.12'
  REGISTRY: ghcr.io

jobs:
  # =========================================================================
  # Job 1: Tests de connectivit√© (Tailscale + Pi + AWS)
  # =========================================================================
  connectivity:
    name: Connectivity Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install connectivity dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tailscale boto3

      - name: üîê Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci
          version: 1.56.1
          args: --advertise-exit-node

      - name: ‚úÖ Connectivity checks (Tailscale + Pi + AWS)
        env:
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          RASPBERRY_PI_TAILSCALE_IP: ${{ secrets.RASPBERRY_PI_TAILSCALE_IP }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          python - <<'PY'
          import asyncio
          import os
          import subprocess
          import sys

          import boto3
          from tailscale import Tailscale

          def require_env(name: str) -> str:
              value = os.getenv(name)
              if not value:
                  raise SystemExit(f"Missing required secret: {name}")
              return value

          async def check_tailscale() -> None:
              tailnet = require_env("TAILSCALE_TAILNET")
              api_key = require_env("TAILSCALE_API_KEY")
              target_ip = require_env("RASPBERRY_PI_TAILSCALE_IP")

              async with Tailscale(tailnet=tailnet, api_key=api_key) as tailscale:
                  devices = await tailscale.devices()
                  for device in devices.devices.values():
                      if target_ip in (device.addresses or []):
                          if not device.authorized:
                              raise SystemExit(f"Tailscale device not authorized: {device.name}")
                          print(f"Tailscale device found: {device.name} ({target_ip})")
                          break
                  else:
                      raise SystemExit(f"Tailscale device not found for IP: {target_ip}")

              subprocess.run(
                  ["tailscale", "ping", "-c", "4", target_ip],
                  check=True,
                  text=True,
              )

          def check_aws() -> None:
              access_key = os.getenv("AWS_ACCESS_KEY_ID")
              secret_key = os.getenv("AWS_SECRET_ACCESS_KEY")
              if not access_key or not secret_key:
                  print("AWS credentials missing; skipping AWS check.")
                  return
              region = os.getenv("AWS_REGION") or "us-east-1"
              session_token = os.getenv("AWS_SESSION_TOKEN")

              session = boto3.Session(
                  aws_access_key_id=access_key,
                  aws_secret_access_key=secret_key,
                  aws_session_token=session_token,
                  region_name=region,
              )
              sts = session.client("sts")
              identity = sts.get_caller_identity()
              print(f"AWS identity OK: {identity.get('Arn')}")

          async def main() -> None:
              await check_tailscale()
              check_aws()
              print("‚úÖ Connectivity checks passed.")

          asyncio.run(main())
          PY
      
      - name: üì• Checkout code (for network visualization)
        uses: actions/checkout@v4
      
      - name: üìä Generate Network Health Map
        if: success()
        env:
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
        run: |
          python - <<'PY'
          import os
          import sys
          sys.path.insert(0, "src")
          
          from ids.monitoring.tailnet_monitor import TailnetMonitor
          
          tailnet = os.getenv("TAILSCALE_TAILNET")
          api_key = os.getenv("TAILSCALE_API_KEY")
          
          monitor = TailnetMonitor(api_key, tailnet)
          snapshot = monitor.get_current_state()
          print(f"üì° Network: {snapshot.total_nodes} nodes ({snapshot.online_nodes} online)")
          
          snapshot = monitor.measure_mesh_latency(snapshot)
          if snapshot.average_latency:
              print(f"‚ö° Average latency: {snapshot.average_latency:.2f}ms")
          
          monitor.generate_interactive_graph(snapshot, "network_health_map.html")
          PY
        continue-on-error: true
      
      - name: üì§ Upload Network Health Map
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: network-health-map
          path: network_health_map.html
          retention-days: 7
        continue-on-error: true

  # =========================================================================
  # Job 2: Tests Unitaires & Int√©gration
  # =========================================================================
  test:
    name: Tests & Analyse Code
    runs-on: ubuntu-latest
    needs: [connectivity]
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history pour Sonar
      
      - name: üêç Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov pytest-asyncio pytest-xdist pytest-timeout
      
      - name: üß™ Run Unit Tests
        run: |
          pytest tests/unit/ \
            -v \
            --cov=src/ids \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=test-results.xml
      
      - name: üß™ Run Integration Tests (Optional)
        run: |
          pytest tests/integration/ \
            -v \
            -m "not requires_network" \
            --timeout=60 \
            || echo "Integration tests skipped or failed"
      
      - name: üìä Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
  # =========================================================================
  # Job 2: V√©rifications Qualit√© Code
  # =========================================================================
  code-quality:
    name: Qualit√© Code (Linting, Type Checking)
    runs-on: ubuntu-latest
    needs: [connectivity]
    continue-on-error: true
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pylint flake8 black isort mypy
      
      - name: üé® Check code format (Black)
        run: black --check src/ tests/
        continue-on-error: true
      
      - name: üìê Check import order (isort)
        run: isort --check-only src/ tests/
        continue-on-error: true
      
      - name: üîç Lint with flake8
        run: flake8 src/ tests/ --max-line-length=100
        continue-on-error: true
      
      - name: üè∑Ô∏è Type checking (mypy)
        run: mypy src/ids --ignore-missing-imports
        continue-on-error: true
  
  # =========================================================================
  # Job 3: Build & D√©ploiement
  # =========================================================================
  deploy:
    name: D√©ploiement Tailscale ‚Üí Raspberry Pi
    runs-on: ubuntu-latest
    needs: [test]
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout codegit
        uses: actions/checkout@v4
      
      - name: üîê Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci
          version: 1.56.1
          args: --advertise-exit-node

      - name: ‚úÖ Verify Tailscale connection
        env:
          DEPLOY_HOST: ${{ secrets.RASPBERRY_PI_TAILSCALE_IP }}
        run: |
          tailscale status --json > /tmp/tailscale-status.json
          tailscale ping -c 4 "$DEPLOY_HOST"
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt
          pip install build twine
      
      - name: üî® Build package
        run: |
          python -m build
      
      - name: üìù Prepare deployment
        run: |
          mkdir -p deploy_package
          cp -r src/ deploy_package/
          cp -r tests/ deploy_package/
          cp requirements.txt deploy_package/
          cp config.yaml deploy_package/
          cp -r docker/ deploy_package/
          cp -r suricata/ deploy_package/
          cp -r vector/ deploy_package/
      
      - name: üì§ Deploy via SCP (Tailscale)
        env:
          DEPLOY_HOST: ${{ secrets.RASPBERRY_PI_TAILSCALE_IP }}
          DEPLOY_USER: ${{ secrets.RASPBERRY_PI_USER }}
          DEPLOY_PATH: /opt/ids
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.RASPBERRY_PI_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Cr√©er r√©pertoire destination (sudo requis pour /opt)
          ssh -i ~/.ssh/id_rsa $DEPLOY_USER@$DEPLOY_HOST \
            "sudo mkdir -p $DEPLOY_PATH && sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH"
          
          # Upload des fichiers
          scp -i ~/.ssh/id_rsa -r deploy_package/* \
            $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          
          # Permissions
          ssh -i ~/.ssh/id_rsa $DEPLOY_USER@$DEPLOY_HOST \
            "sudo chmod -R 755 $DEPLOY_PATH && \
             sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH"
      
      - name: üöÄ Restart IDS Service
        env:
          DEPLOY_HOST: ${{ secrets.RASPBERRY_PI_TAILSCALE_IP }}
          DEPLOY_USER: ${{ secrets.RASPBERRY_PI_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa $DEPLOY_USER@$DEPLOY_HOST \
            "sudo systemctl restart ids2-agent || echo 'Service restart skipped'"
        continue-on-error: true
      
      - name: ‚úÖ Verify Deployment
        env:
          DEPLOY_HOST: ${{ secrets.RASPBERRY_PI_TAILSCALE_IP }}
          DEPLOY_USER: ${{ secrets.RASPBERRY_PI_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa $DEPLOY_USER@$DEPLOY_HOST \
            "ps aux | grep -i ids || echo 'IDS service check skipped'"
        continue-on-error: true
  
  # =========================================================================
  # Job 4: Notifications
  # =========================================================================
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [test, code-quality, deploy]
    if: always()
    
    steps:
      - name: üì¢ Slack Notification (Optional)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "IDS CI/CD Pipeline",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Pipeline Failed*\n*Workflow*: ${{ github.workflow }}\n*Branch*: ${{ github.ref }}\n*Commit*: ${{ github.sha }}"
                  }
                }
              ]
            }
        continue-on-error: true
      
      - name: ‚úÖ Success Summary
        if: success()
        run: |
          echo "‚úÖ All checks passed!"
          echo "‚úÖ Tests: OK"
          echo "‚úÖ Code Quality: OK"
          echo "‚úÖ Deployment: OK"
