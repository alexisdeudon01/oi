name: UML Diagrams - Auto-generation Pipeline

on:
  push:
    branches: [main, dev, develop]
    paths:
      - 'src/**/*.py'
      - 'scripts/generate_uml.py'
      - '.github/workflows/uml-generation.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'src/**/*.py'
  workflow_dispatch:  # Manual trigger
    inputs:
      force_regenerate:
        description: 'Force regenerate all diagrams'
        required: false
        default: 'true'

env:
  PYTHON_VERSION: '3.12'
  UML_OUTPUT_DIR: 'docs/uml'

jobs:
  # =========================================================================
  # Job 1: Generate UML Diagrams
  # =========================================================================
  generate-uml:
    name: Generate UML Diagrams
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diagrams
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          dot -V
      
      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint>=3.0.0
          pyreverse --version
      
      - name: ğŸ¨ Generate UML diagrams
        run: |
          python scripts/generate_uml.py --output-dir ${{ env.UML_OUTPUT_DIR }}
      
      - name: ğŸ” Run architecture analysis
        id: analysis
        run: |
          python scripts/analyze_architecture.py > architecture-report.txt 2>&1 || true
          cat architecture-report.txt
          
          # Extract health score for summary
          HEALTH_SCORE=$(grep "Health score:" architecture-report.txt | sed 's/.*Health score: \([0-9.]*\).*/\1/' || echo "0")
          echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ğŸ“Š Verify generated diagrams
        run: |
          echo "Generated UML diagrams:"
          ls -lh ${{ env.UML_OUTPUT_DIR }}/*.png || echo "No PNG files found"
          
          # Check that key diagrams were generated
          test -f ${{ env.UML_OUTPUT_DIR }}/classes_ids_detailed.png || exit 1
          test -f ${{ env.UML_OUTPUT_DIR }}/packages_ids_packages.png || exit 1
          
          echo "âœ… All key diagrams generated successfully"
      
      - name: ğŸ“ˆ Calculate diagram metrics
        id: metrics
        run: |
          DIAGRAM_COUNT=$(ls -1 ${{ env.UML_OUTPUT_DIR }}/*.png 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh ${{ env.UML_OUTPUT_DIR }} | cut -f1)
          
          echo "diagram_count=$DIAGRAM_COUNT" >> $GITHUB_OUTPUT
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Metrics:"
          echo "  - Diagrams generated: $DIAGRAM_COUNT"
          echo "  - Total size: $TOTAL_SIZE"
      
      - name: ğŸ“¤ Upload UML diagrams as artifact
        uses: actions/upload-artifact@v4
        with:
          name: uml-diagrams
          path: ${{ env.UML_OUTPUT_DIR }}/*.png
          retention-days: 90
      
      - name: ğŸ“¤ Upload UML index
        uses: actions/upload-artifact@v4
        with:
          name: uml-index
          path: ${{ env.UML_OUTPUT_DIR }}/INDEX.md
          retention-days: 90
      
      - name: ğŸ“¤ Upload architecture report
        uses: actions/upload-artifact@v4
        with:
          name: architecture-report
          path: architecture-report.txt
          retention-days: 90
      
      - name: ğŸ“¤ Upload metrics history
        uses: actions/upload-artifact@v4
        with:
          name: metrics-history
          path: ${{ env.UML_OUTPUT_DIR }}/metrics_history.json
          retention-days: 90
        continue-on-error: true
      
      - name: ğŸ’¾ Commit and push UML diagrams
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add ${{ env.UML_OUTPUT_DIR }}/*.png ${{ env.UML_OUTPUT_DIR }}/INDEX.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¨ Auto-generate UML diagrams [skip ci]"
            git push
          fi
      
      - name: ğŸ“ Generate summary
        run: |
          echo "## ğŸ¨ UML Diagram Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully generated **${{ steps.metrics.outputs.diagram_count }}** UML diagrams" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ Total size: **${{ steps.metrics.outputs.total_size }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ—ï¸ Architecture Health Score: **${{ steps.analysis.outputs.health_score }}/100**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Diagrams" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Class Diagram | Package Diagram |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | classes_ids_detailed.png | packages_ids_packages.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | classes_ids_domain.png | packages_ids_domain.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Interfaces | classes_ids_interfaces.png | packages_ids_interfaces.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Composants | classes_ids_composants.png | packages_ids_composants.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | classes_ids_infrastructure.png | packages_ids_infrastructure.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Suricata | classes_ids_suricata.png | packages_ids_suricata.png |" >> $GITHUB_STEP_SUMMARY
          echo "| App | classes_ids_app.png | packages_ids_app.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Config | classes_ids_config.png | packages_ids_config.png |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | classes_ids_deploy.png | packages_ids_deploy.png |" >> $GITHUB_STEP_SUMMARY
  
  # =========================================================================
  # Job 2: Code Quality Analysis (runs in parallel)
  # =========================================================================
  code-quality-check:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint>=3.0.0
          pip install -r requirements.txt || true
      
      - name: ğŸ” Run pylint analysis
        id: pylint
        run: |
          pylint src/ids --output-format=text --exit-zero > pylint-report.txt
          SCORE=$(grep "Your code has been rated" pylint-report.txt | sed 's/.*rated at \([0-9.]*\).*/\1/')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          cat pylint-report.txt
        continue-on-error: true
      
      - name: ğŸ“¤ Upload pylint report
        uses: actions/upload-artifact@v4
        with:
          name: pylint-report
          path: pylint-report.txt
          retention-days: 30
      
      - name: ğŸ“ Add quality summary
        run: |
          echo "## ğŸ” Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pylint Score:** ${{ steps.pylint.outputs.score }}/10.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See the full report in the artifacts." >> $GITHUB_STEP_SUMMARY
  
  # =========================================================================
  # Job 3: Notify completion
  # =========================================================================
  notify-completion:
    name: Pipeline Completion
    runs-on: ubuntu-latest
    needs: [generate-uml, code-quality-check]
    if: always()
    
    steps:
      - name: âœ… Success notification
        if: needs.generate-uml.result == 'success'
        run: |
          echo "âœ… UML generation pipeline completed successfully!"
          echo "ğŸ“ Diagrams are available as artifacts"
          echo "ğŸ”— View in Actions artifacts tab"
      
      - name: âŒ Failure notification
        if: needs.generate-uml.result == 'failure'
        run: |
          echo "âŒ UML generation pipeline failed"
          echo "Please check the logs above for details"
          exit 1
