version: '3.8'
services:
  vector:
    image: timberio/vector:0.34.0-alpine
    command: ["vector", "--config", "/etc/vector/vector.toml"]
    volumes:
      - ./vector.toml:/etc/vector/vector.toml:ro
      - /mnt/ram_logs:/mnt/ram_logs # Volume pour les logs Suricata
      - /var/lib/vector/buffer:/var/lib/vector/buffer # Tampon disque pour Vector
      - /var/lib/vector/redis_buffer:/var/lib/vector/redis_buffer # Tampon disque pour Redis fallback
      - /var/lib/vector/opensearch_buffer:/var/lib/vector/opensearch_buffer # Tampon disque pour OpenSearch
    environment:
      # Variables d'environnement pour l'authentification AWS
      # Chargees depuis secret.json via l'agent Python
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-eu-central-1}
      OPENSEARCH_ENDPOINT: ${OPENSEARCH_ENDPOINT:-}
      VECTOR_SELF_THROTTLING_LEVEL: 0 # Sera mis a jour par l'agent Python
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_VECTOR_CPU:-1.0}" # 1 coeur pour Vector
          memory: "${DOCKER_VECTOR_RAM_MB:-1024}M" # ~1 GB RAM pour Vector
    depends_on:
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_REDIS_CPU:-0.5}"
          memory: "${DOCKER_REDIS_RAM_MB:-512}M"
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.47.0
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_PROMETHEUS_CPU:-0.2}"
          memory: "${DOCKER_PROMETHEUS_RAM_MB:-256}M"
    depends_on:
      - node_exporter
      - cadvisor
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.1.5
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_GRAFANA_CPU:-0.2}"
          memory: "${DOCKER_GRAFANA_RAM_MB:-256}M"
    depends_on:
      - prometheus
    restart: unless-stopped

  fastapi:
    build:
      context: ..
      dockerfile: docker/fastapi/Dockerfile
    image: ids2-fastapi:latest
    working_dir: /app
    volumes:
      - ../src:/app/src:ro
    environment:
      PYTHONPATH: /app/src
    command: ["uvicorn", "ids.app.api_status:app", "--host", "0.0.0.0", "--port", "8080"]
    ports:
      - "8080:8080"
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_FASTAPI_CPU:-0.5}"
          memory: "${DOCKER_FASTAPI_RAM_MB:-256}M"
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8081:8080"
    privileged: true
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_CADVISOR_CPU:-0.1}"
          memory: "${DOCKER_CADVISOR_RAM_MB:-64}M"
    restart: unless-stopped

  node_exporter:
    image: prom/node-exporter:v1.6.1
    command:
      - '--path.rootfs=/host'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro,rslave
    ports:
      - "9100:9100"
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_NODE_EXPORTER_CPU:-0.1}"
          memory: "${DOCKER_NODE_EXPORTER_RAM_MB:-64}M"
    restart: unless-stopped

volumes:
  redis_data:
  prometheus_data:
  grafana_data:
